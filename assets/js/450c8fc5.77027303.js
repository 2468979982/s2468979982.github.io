"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[3026],{1076:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>l});var t=r(7624),i=r(2172);const a={title:"Spring Security OAuth2 \u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5 (PKCE) \u7684\u6388\u6743\u7801\u6d41",date:new Date("2022-07-17T12:21:50.000Z"),tags:["OAuth2","SpringSecurity"],draft:!1,authors:["default"]},s=void 0,o={permalink:"/blog/oauth2-pkce",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/oauth2-pkce.mdx",source:"@site/blog/oauth2-pkce.mdx",title:"Spring Security OAuth2 \u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5 (PKCE) \u7684\u6388\u6743\u7801\u6d41",description:"Spring Security OAuth2 \u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5 (PKCE) \u7684\u6388\u6743\u7801\u6d41",date:"2022-07-17T12:21:50.000Z",formattedDate:"July 17, 2022",tags:[{label:"OAuth2",permalink:"/blog/tags/o-auth-2"},{label:"SpringSecurity",permalink:"/blog/tags/spring-security"}],readingTime:10.89,hasTruncateMarker:!1,authors:[{name:"lzs",title:"Maintainer of Docusaurus",url:"https://github.com/2468979982",imageURL:"https://github.com/2468979982.png",key:"default"}],frontMatter:{title:"Spring Security OAuth2 \u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5 (PKCE) \u7684\u6388\u6743\u7801\u6d41",date:"2022-07-17T12:21:50.000Z",tags:["OAuth2","SpringSecurity"],draft:!1,authors:["default"]},unlisted:!1,prevItem:{title:"Spring Security OAuth2 Opaque \u4ee4\u724c\u7684\u7b80\u5355\u4f7f\u7528\u6307\u5357",permalink:"/blog/oauth2-opaque-token"},nextItem:{title:"Spring Security OAuth2\u5ba2\u6237\u7aef\u51ed\u636e\u6388\u6743",permalink:"/blog/oauth2-client-model"}},c={authorsImageUrls:[void 0]},l=[{value:"Spring Security OAuth2 \u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5 (PKCE) \u7684\u6388\u6743\u7801\u6d41",id:"spring-security-oauth2-\u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5-pkce-\u7684\u6388\u6743\u7801\u6d41",level:2},{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:3},{value:"Proof Key for Code Exchange",id:"proof-key-for-code-exchange",level:3},{value:"\u4f7f\u7528Spring Authorization Server\u642d\u5efa\u6388\u6743\u670d\u52a1\u5668",id:"\u4f7f\u7528spring-authorization-server\u642d\u5efa\u6388\u6743\u670d\u52a1\u5668",level:3},{value:"maven",id:"maven",level:4},{value:"\u914d\u7f6e",id:"\u914d\u7f6e",level:4},{value:"OAuth2\u5ba2\u6237\u7aef",id:"oauth2\u5ba2\u6237\u7aef",level:3},{value:"maven",id:"maven-1",level:4},{value:"\u914d\u7f6e",id:"\u914d\u7f6e-1",level:4},{value:"\u8d44\u6e90\u670d\u52a1\u5668",id:"\u8d44\u6e90\u670d\u52a1\u5668",level:3},{value:"maven",id:"maven-2",level:4},{value:"\u914d\u7f6e",id:"\u914d\u7f6e-2",level:4},{value:"\u8bbf\u95ee\u8d44\u6e90\u5217\u8868",id:"\u8bbf\u95ee\u8d44\u6e90\u5217\u8868",level:3},{value:"\u7ed3\u8bba",id:"\u7ed3\u8bba",level:3}];function d(e){const n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"spring-security-oauth2-\u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5-pkce-\u7684\u6388\u6743\u7801\u6d41",children:"Spring Security OAuth2 \u5e26\u6709\u7528\u4e8e\u4ee3\u7801\u4ea4\u6362\u7684\u8bc1\u660e\u5bc6\u94a5 (PKCE) \u7684\u6388\u6743\u7801\u6d41"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:r(6672).c+"",width:"1400",height:"1019"})}),"\n",(0,t.jsx)(n.h3,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,t.jsxs)(n.p,{children:["OAuth2\u4f9d\u636e\u662f\u5426\u80fd\u6301\u6709\u5ba2\u6237\u7aef\u5bc6\u94a5\uff0c\u5c06\u5ba2\u6237\u7aef\u5206\u4e3a\u4e24\u79cd\u7c7b\u578b\uff1a",(0,t.jsx)(n.strong,{children:"\u516c\u5171\u5ba2\u6237\u7aef"}),"\u548c",(0,t.jsx)(n.strong,{children:"\u4fdd\u5bc6\u5ba2\u6237\u7aef"}),"\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u4fdd\u5bc6\u5ba2\u6237\u7aef"}),"\u5728\u670d\u52a1\u5668\u4e0a\u8fd0\u884c\uff0c\u5728\u524d\u9762\u4ecb\u7ecdOAuth2\u6587\u7ae0\u4e2dSpring Boot\u521b\u5efa\u7684\u5e94\u7528\u7a0b\u5e8f\u662f\u4fdd\u5bc6\u5ba2\u6237\u7aef\u7c7b\u578b\u7684\u793a\u4f8b\u3002\u9996\u5148\u5b83\u4eec\u5728\u670d\u52a1\u5668\u4e0a\u8fd0\u884c\uff0c\u5e76\u4e14\u901a\u5e38\u4f4d\u4e8e\u5177\u6709\u5176\u4ed6\u4fdd\u62a4\u63aa\u65bd\u9632\u706b\u5899\u6216\u7f51\u5173\u7684\u540e\u9762\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u516c\u5171\u5ba2\u6237\u7aef"}),"\u7684\u4ee3\u7801\u4e00\u822c\u4f1a\u4ee5\u67d0\u79cd\u5f62\u5f0f\u66b4\u9732\u7ed9\u6700\u7ec8\u7528\u6237\uff0c\u8981\u4e48\u662f\u5728\u6d4f\u89c8\u5668\u4e2d\u4e0b\u8f7d\u6267\u884c\uff0c\u8981\u4e48\u662f\u76f4\u63a5\u5728\u7528\u6237\u7684\u8bbe\u5907\u4e0a\u8fd0\u884c\u3002\u4f8b\u5982",(0,t.jsx)(n.strong,{children:"\u539f\u751f\u5e94\u7528"}),"\u662f\u76f4\u63a5\u5728\u6700\u7ec8\u7528\u6237\u7684\u8bbe\u5907\uff08\u8ba1\u7b97\u673a\u6216\u8005\u79fb\u52a8\u8bbe\u5907\uff09\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u3002\u8fd9\u7c7b\u5e94\u7528\u5728\u4f7f\u7528OAuth2\u534f\u8bae\u65f6\uff0c\u6211\u4eec\u65e0\u6cd5\u4fdd\u8bc1\u4e3a\u6b64\u5e94\u7528\u9881\u53d1\u7684\u5ba2\u6237\u7aef\u5bc6\u94a5\u80fd\u5b89\u5168\u7684\u5b58\u50a8\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u5e94\u7528\u7a0b\u5e8f\u5728\u8fd0\u884c\u4e4b\u524d\u4f1a\u5b8c\u5168\u4e0b\u8f7d\u5230\u8bbe\u5907\u4e0a\uff0c\u53cd\u7f16\u8bd1\u5e94\u7528\u7a0b\u5e8f\u5c06\u5b8c\u5168\u663e\u793a\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u540c\u6837\u5b58\u5728\u6b64\u5b89\u5168\u95ee\u9898\u8fd8\u6709",(0,t.jsx)(n.strong,{children:"\u5355\u9875\u5e94\u7528"}),"\uff08SPA\uff09\uff0c\u6d4f\u89c8\u5668\u672c\u8eab\u662f\u4e00\u4e2a\u4e0d\u5b89\u5168\u7684\u73af\u5883\uff0c\u4e00\u65e6\u4f60\u52a0\u8f7dJavaScript\u5e94\u7528\u7a0b\u5e8f\uff0c\u6d4f\u89c8\u5668\u5c06\u4f1a\u4e0b\u8f7d\u6574\u4e2a\u6e90\u4ee3\u7801\u4ee5\u4fbf\u8fd0\u884c\u5b83\uff0c\u6574\u4e2a\u6e90\u4ee3\u7801\uff0c\u5305\u62ec\u5176\u4e2d\u7684\u4efb\u4f55 \u5ba2\u6237\u7aef\u5bc6\u94a5\uff0c\u90fd\u5c06\u53ef\u89c1\u3002\u5982\u679c\u4f60\u6784\u5efa\u4e00\u4e2a\u62e5\u6709100000\u540d\u7528\u6237\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u90a3\u4e48\u5f88\u53ef\u80fd\u8fd9\u4e9b\u7528\u6237\u4e2d\u7684\u4e00\u90e8\u5206\u5c06\u611f\u67d3\u6076\u610f\u8f6f\u4ef6\u6216\u75c5\u6bd2\uff0c\u5e76\u6cc4\u6f0f\u5ba2\u6237\u7aef\u5bc6\u94a5\u3002"]}),"\n",(0,t.jsx)(n.p,{children:"\u4f60\u53ef\u80fd\u4f1a\u60f3\uff0c\u201c\u5982\u679c\u6211\u901a\u8fc7\u5c06\u5ba2\u6237\u7aef\u5bc6\u94a5\u62c6\u5206\u4e3a\u51e0\u4e2a\u90e8\u5206\u8fdb\u884c\u6df7\u6dc6\u5462\uff1f\u201d\u8fd9\u4e0d\u53ef\u5426\u8ba4\u4f1a\u4e3a\u4f60\u4e89\u53d6\u70b9\u65f6\u95f4\uff0c\u4f46\u771f\u6b63\u6709\u51b3\u5fc3\u7684\u4eba\u4ecd\u53ef\u80fd\u4f1a\u5f04\u6e05\u695a\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u4e3a\u4e86\u89c4\u907f\u8fd9\u79cd\u5b89\u5168\u98ce\u9669\uff0c\u6700\u597d\u4f7f\u7528\u4ee3\u7801\u4ea4\u6362\u8bc1\u660e\u5bc6\u94a5(PKCE)\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"proof-key-for-code-exchange",children:"Proof Key for Code Exchange"}),"\n",(0,t.jsxs)(n.p,{children:["PKCE \u6709\u81ea\u5df1\u72ec\u7acb\u7684",(0,t.jsx)(n.a,{href:"https://tools.ietf.org/html/rfc7636",children:"\u89c4\u8303"}),"\u3002\u5b83\u4f7f\u5e94\u7528\u7a0b\u5e8f\u80fd\u591f\u5728\u516c\u5171\u5ba2\u6237\u7aef\u4e2d\u4f7f\u7528\u6388\u6743\u7801\u6d41\u7a0b\u3002"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{src:r(2868).c+"",width:"909",height:"785"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u7528\u6237\u5728\u5ba2\u6237\u7aef\u8bf7\u6c42\u8d44\u6e90\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u521b\u5efa\u5e76\u8bb0\u5f55\u540d\u4e3a code_verifier \u7684\u79d8\u5bc6\u4fe1\u606f\uff0c\u7136\u540e\u5ba2\u6237\u7aef\u6839\u636e code_verifier \u8ba1\u7b97\u51fa code_challenge\uff0c\u5b83\u7684\u503c\u53ef\u4ee5\u662f code_verifier\uff0c\u4e5f\u53ef\u4ee5\u662f code_verifier \u7684 SHA-256 \u6563\u5217\uff0c\u4f46\u662f\u5e94\u8be5\u4f18\u5148\u8003\u8651\u4f7f\u7528\u5bc6\u7801\u6563\u5217\uff0c\u56e0\u4e3a\u5b83\u80fd\u9632\u6b62\u9a8c\u8bc1\u5668\u672c\u8eab\u906d\u5230\u622a\u83b7\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5c06 code_challenge \u4ee5\u53ca\u53ef\u9009\u7684 code_challenge_method(\u4e00\u4e2a\u5173\u952e\u5b57\uff0c\u8868 \u793a\u539f\u6587\u6216\u8005 SHA-256 \u6563\u5217)\u4e0e\u5e38\u89c4\u7684\u6388\u6743\u8bf7\u6c42\u53c2\u6570\u4e00\u8d77\u53d1\u9001\u7ed9\u6388\u6743\u670d\u52a1\u5668\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u6388\u6743\u670d\u52a1\u5668\u5c06\u7528\u6237\u91cd\u5b9a\u5411\u5230\u767b\u5f55\u9875\u9762\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u7528\u6237\u4f7f\u8fdb\u884c\u8eab\u4efd\u9a8c\u8bc1\uff0c\u5e76\u4e14\u53ef\u80fd\u4f1a\u770b\u5230\u4e00\u4e2a\u540c\u610f\u9875\u9762\uff0c\u5176\u4e2d\u5217\u51fa\u4e86 \u6388\u6743\u670d\u52a1\u5668\u5c06\u6388\u4e88\u5ba2\u6237\u7aef\u7684\u6743\u9650\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u6388\u6743\u670d\u52a1\u5668\u5c06 code_challenge \u548c code_challenge_method(\u5982\u679c\u6709 \u7684\u8bdd)\u8bb0\u5f55\u4e0b\u6765\u3002\u6388\u6743\u670d\u52a1\u5668\u4f1a\u5c06\u8fd9\u4e9b\u4fe1\u606f\u4e0e\u9881\u53d1\u7684\u6388\u6743\u7801\u5173\u8054\u8d77\u6765\uff0c\u5e76\u643a\u5e26code\u91cd\u5b9a\u5411\u56de\u5ba2\u6237\u7aef\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u63a5\u6536\u5230\u6388\u6743\u7801\u4e4b\u540e\uff0c\u643a\u5e26\u4e4b\u524d\u751f\u6210\u7684 code_verifier \u6267\u884c\u4ee4\u724c\u8bf7\u6c42\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u6388\u6743\u670d\u52a1\u5668\u6839\u636ecode_verifier\u8ba1\u7b97\u51fa code_challenge\uff0c\u5e76\u68c0\u67e5\u662f\u5426\u4e0e\u6700\u521d\u63d0\u4ea4\u7684code_challenge\u4e00\u81f4\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u6388\u6743\u670d\u52a1\u5668\u5411\u5ba2\u6237\u7aef\u53d1\u9001\u4ee4\u724c\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u5411\u53d7\u4fdd\u62a4\u8d44\u6e90\u53d1\u9001\u4ee4\u724c\u3002"}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"\u53d7\u4fdd\u62a4\u8d44\u6e90\u5411\u5ba2\u6237\u7aef\u8fd4\u56de\u8d44\u6e90\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"\u4f7f\u7528spring-authorization-server\u642d\u5efa\u6388\u6743\u670d\u52a1\u5668",children:"\u4f7f\u7528Spring Authorization Server\u642d\u5efa\u6388\u6743\u670d\u52a1\u5668"}),"\n",(0,t.jsxs)(n.p,{children:["\u672c\u8282\u6211\u4eec\u5c06\u4f7f\u7528",(0,t.jsx)(n.a,{href:"https://spring.io/projects/spring-authorization-server",children:"Spring Authorization Server"}),"\u642d\u5efa\u4e00\u4e2a\u6388\u6743\u670d\u52a1\u5668\uff0c\u5e76\u6ce8\u518c\u4e00\u4e2a\u5ba2\u6237\u7aef\u4f7f\u4e4b\u652f\u6301PKCE\u3002"]}),"\n",(0,t.jsx)(n.h4,{id:"maven",children:"maven"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-security</artifactId>\n  <version>2.6.7</version>\n</dependency>\n\n<dependency>\n  <groupId>org.springframework.security</groupId>\n  <artifactId>spring-security-oauth2-authorization-server</artifactId>\n  <version>0.3.1</version>\n</dependency>\n\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-web</artifactId>\n  <version>2.6.7</version>\n</dependency>\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u914d\u7f6e",children:"\u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"\u9996\u5148\u5f88\u7b80\u5355\uff0c\u6211\u4eec\u5c06\u521b\u5efaapplication.yml\u6587\u4ef6\uff0c\u5e76\u6307\u5b9a\u6388\u6743\u670d\u52a1\u5668\u7aef\u53e3\u4e3a8080\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 8080\n"})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsxs)(n.p,{children:["\u4e4b\u540e\u6211\u4eec\u5c06\u521b\u5efa\u4e00\u4e2a",(0,t.jsx)(n.code,{children:"OAuth2ServerConfig"}),"\u914d\u7f6e\u7c7b\uff0c\u5e76\u5728\u6b64\u7c7b\u4e2d\u6211\u4eec\u5c06\u521b\u5efaOAuth2\u6388\u6743\u670d\u52a1\u6240\u9700\u7279\u5b9aBean\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Bean\n@Order(Ordered.HIGHEST_PRECEDENCE)\npublic SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception {\n  OAuth2AuthorizationServerConfiguration.applyDefaultSecurity(http);\n  return http.exceptionHandling(exceptions -> exceptions.\n                                authenticationEntryPoint(new LoginUrlAuthenticationEntryPoint("/login"))).build();\n}\n\n@Bean\npublic RegisteredClientRepository registeredClientRepository() {\n  RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())\n    .clientId("relive-client")\n    .clientAuthenticationMethods(s -> {\n      s.add(ClientAuthenticationMethod.NONE);//\u5ba2\u6237\u7aef\u8ba4\u8bc1\u6a21\u5f0f\u4e3anone\n    })\n    .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)\n    .redirectUri("http://127.0.0.1:8070/login/oauth2/code/messaging-client-pkce")\n    .scope("message.read")\n    .clientSettings(ClientSettings.builder()\n                    .requireAuthorizationConsent(true)\n                    .requireProofKey(true) //\u4ec5\u652f\u6301PKCE\n                    .build())\n    .tokenSettings(TokenSettings.builder()\n                   .accessTokenFormat(OAuth2TokenFormat.SELF_CONTAINED) // \u751f\u6210JWT\u4ee4\u724c\n                   .idTokenSignatureAlgorithm(SignatureAlgorithm.RS256)\n                   .accessTokenTimeToLive(Duration.ofSeconds(30 * 60))\n                   .refreshTokenTimeToLive(Duration.ofSeconds(60 * 60))\n                   .reuseRefreshTokens(true)\n                   .build())\n    .build();\n\n  return new InMemoryRegisteredClientRepository(registeredClient);\n}\n\n@Bean\npublic ProviderSettings providerSettings() {\n  return ProviderSettings.builder()\n    .issuer("http://127.0.0.1:8080")\n    .build();\n}\n\n@Bean\npublic JWKSource<SecurityContext> jwkSource() {\n  RSAKey rsaKey = Jwks.generateRsa();\n  JWKSet jwkSet = new JWKSet(rsaKey);\n  return (jwkSelector, securityContext) -> jwkSelector.select(jwkSet);\n}\n\nstatic class Jwks {\n\n  private Jwks() {\n  }\n\n  public static RSAKey generateRsa() {\n    KeyPair keyPair = KeyGeneratorUtils.generateRsaKey();\n    RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();\n    RSAPrivateKey privateKey = (RSAPrivateKey) keyPair.getPrivate();\n    return new RSAKey.Builder(publicKey)\n      .privateKey(privateKey)\n      .keyID(UUID.randomUUID().toString())\n      .build();\n  }\n}\n\nstatic class KeyGeneratorUtils {\n\n  private KeyGeneratorUtils() {\n  }\n\n  static KeyPair generateRsaKey() {\n    KeyPair keyPair;\n    try {\n      KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance("RSA");\n      keyPairGenerator.initialize(2048);\n      keyPair = keyPairGenerator.generateKeyPair();\n    } catch (Exception ex) {\n      throw new IllegalStateException(ex);\n    }\n    return keyPair;\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u8bf7\u6ce8\u610f"}),"\u5728\u521b\u5efa",(0,t.jsx)(n.em,{children:"RegisteredClient"}),"\u6ce8\u518c\u5ba2\u6237\u7aef\u7c7b\u4e2d\uff0c1.\u6211\u4eec\u6ca1\u6709\u5b9a\u4e49",(0,t.jsx)(n.code,{children:"client_secret"}),";2.\u5ba2\u6237\u7aef\u8ba4\u8bc1\u6a21\u5f0f\u6307\u5b9a\u4e3anone\uff1b3.requireProofKey()\u8bbe\u7f6e\u4e3atrue\uff0c\u6b64\u5ba2\u6237\u7aef\u4ec5\u652f\u6301PKCE\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5176\u4f59\u914d\u7f6e\u6211\u8fd9\u91cc\u5c31\u4e0d\u4e00\u4e00\u8bf4\u660e\uff0c\u53ef\u4ee5\u53c2\u8003",(0,t.jsx)(n.a,{href:"https://relive27.github.io/blog/spring-security-oauth2-jwt",children:"\u4e4b\u524d\u6587\u7ae0"}),"\u3002"]}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2aSpring Security\u7684\u914d\u7f6e\u7c7b\uff0c\u6307\u5b9aForm\u8868\u5355\u8ba4\u8bc1\u548c\u8bbe\u7f6e\u7528\u6237\u540d\u5bc6\u7801\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class SecurityConfig {\n\n    @Bean\n    SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .authorizeRequests(authorizeRequests ->\n                        authorizeRequests.anyRequest().authenticated()\n                )\n                .formLogin(withDefaults());\n        return http.build();\n    }\n\n    @Bean\n    UserDetailsService users() {\n        UserDetails user = User.withDefaultPasswordEncoder()\n                .username("admin")\n                .password("password")\n                .roles("USER")\n                .build();\n        return new InMemoryUserDetailsManager(user);\n    }\n\n    @Bean\n    PasswordEncoder passwordEncoder() {\n        return PasswordEncoderFactories.createDelegatingPasswordEncoder();\n    }\n}\n\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u81f3\u6b64\u6211\u4eec\u5c31\u5df2\u7ecf\u914d\u7f6e\u597d\u4e86\u4e00\u4e2a\u7b80\u5355\u7684\u6388\u6743\u670d\u52a1\u5668\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"oauth2\u5ba2\u6237\u7aef",children:"OAuth2\u5ba2\u6237\u7aef"}),"\n",(0,t.jsxs)(n.p,{children:["\u672c\u8282\u4e2d\u6211\u4eec\u4f7f\u7528",(0,t.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/servlet/oauth2/client/index.html",children:"Spring Security"}),"\u521b\u5efa\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c\u6b64\u5ba2\u6237\u7aef\u901a\u8fc7PKCE\u6388\u6743\u7801\u6d41\u5411\u6388\u6743\u670d\u52a1\u5668\u8bf7\u6c42\u6388\u6743\uff0c\u5e76\u5c06\u83b7\u53d6\u7684access_token\u53d1\u9001\u5230\u8d44\u6e90\u670d\u52a1\u3002"]}),"\n",(0,t.jsx)(n.h4,{id:"maven-1",children:"maven"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-web</artifactId>\n  <version>2.6.7</version>\n</dependency>\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-security</artifactId>\n  <version>2.6.7</version>\n</dependency>\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-oauth2-client</artifactId>\n  <version>2.6.7</version>\n</dependency>\n<dependency>\n  <groupId>org.springframework</groupId>\n  <artifactId>spring-webflux</artifactId>\n  <version>5.3.9</version>\n</dependency>\n<dependency>\n  <groupId>io.projectreactor.netty</groupId>\n  <artifactId>reactor-netty</artifactId>\n  <version>1.0.9</version>\n</dependency>\n\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u914d\u7f6e-1",children:"\u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"\u9996\u5148\u6211\u4eec\u5c06\u5728application.yml\u4e2d\u914d\u7f6e\u5ba2\u6237\u7aef\u4fe1\u606f\uff0c\u5e76\u6307\u5b9a\u670d\u52a1\u7aef\u53e3\u53f7\u4e3a8070\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'server:\n  port: 8070\n  servlet:\n    session:\n      cookie:\n        name: CLIENT-SESSION\n\nspring:\n  security:\n    oauth2:\n      client:\n        registration:\n          messaging-client-pkce:\n            provider: client-provider\n            client-id: relive-client\n            client-secret: relive-client\n            authorization-grant-type: authorization_code\n            client-authentication-method: none\n            redirect-uri: "http://127.0.0.1:8070/login/oauth2/code/{registrationId}"\n            scope: message.read\n            client-name: messaging-client-pkce\n        provider:\n          client-provider:\n            authorization-uri: http://127.0.0.1:8080/oauth2/authorize\n            token-uri: http://127.0.0.1:8080/oauth2/token\n\n'})}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u521b\u5efaSpring Security\u914d\u7f6e\u7c7b\uff0c\u542f\u7528OAuth2\u5ba2\u6237\u7aef\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Configuration\npublic class SecurityConfig {\n\n    @Bean\n    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .authorizeRequests(authorizeRequests ->\n                        //\u4fbf\u4e8e\u6d4b\u8bd5\uff0c\u5c06\u6743\u9650\u5f00\u653e\n                        authorizeRequests.anyRequest().permitAll()\n                )\n                .oauth2Client(withDefaults());\n        return http.build();\n    }\n\n    @Bean\n    WebClient webClient(OAuth2AuthorizedClientManager authorizedClientManager) {\n        ServletOAuth2AuthorizedClientExchangeFilterFunction oauth2Client = new ServletOAuth2AuthorizedClientExchangeFilterFunction(authorizedClientManager);\n        return WebClient.builder()\n                .filter(oauth2Client)\n                .build();\n    }\n\n    @Bean\n    OAuth2AuthorizedClientManager authorizedClientManager(ClientRegistrationRepository clientRegistrationRepository,\n                                                          OAuth2AuthorizedClientRepository authorizedClientRepository) {\n\n        OAuth2AuthorizedClientProvider authorizedClientProvider = OAuth2AuthorizedClientProviderBuilder\n                .builder()\n                .authorizationCode()\n                .refreshToken()\n                .build();\n        DefaultOAuth2AuthorizedClientManager authorizedClientManager = new DefaultOAuth2AuthorizedClientManager(clientRegistrationRepository, authorizedClientRepository);\n        authorizedClientManager.setAuthorizedClientProvider(authorizedClientProvider);\n\n        return authorizedClientManager;\n    }\n}\n\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4e0a\u8ff0\u914d\u7f6e\u7c7b\u4e2d\u6211\u4eec\u901a\u8fc7",(0,t.jsxs)(n.em,{children:["oauth2Client(withDefaults())",(0,t.jsxs)(n.em,{children:["\u542f\u7528OAuth2\u5ba2\u6237\u7aef\u3002\u5e76\u521b\u5efa\u4e00\u4e2aWebClient\u5b9e\u4f8b\u7528\u4e8e\u5411\u8d44\u6e90\u670d\u52a1\u5668\u6267\u884cHTTP\u8bf7\u6c42\u3002",(0,t.jsx)(n.code,{children:"OAuth2AuthorizedClientManager"}),"\u8fd9\u662f\u534f\u8c03OAuth2\u6388\u6743\u7801\u8bf7\u6c42\u7684\u9ad8\u7ea7\u63a7\u5236\u5668\u7c7b\uff0c\u4e0d\u8fc7\u6388\u6743\u7801\u6d41\u7a0b\u5e76\u4e0d\u662f\u7531\u5b83\u63a7\u5236\uff0c\u53ef\u4ee5\u67e5\u770b\u5b83\u6240\u7ba1\u7406\u7684"]}),"Provider"]}),"\u5b9e\u73b0\u7c7b",(0,t.jsx)(n.em,{children:"AuthorizationCodeOAuth2AuthorizedClientProvider"}),"\u4e2d\u5e76\u6ca1\u6709\u6d89\u53ca\u76f8\u5173\u6388\u6743\u7801\u6d41\u7a0b\u4ee3\u7801\u903b\u8f91\uff0c\u5bf9\u4e8eSpring Security\u6388\u6743\u7801\u6a21\u5f0f\u6d89\u53ca\u6838\u5fc3\u63a5\u53e3\u6d41\u7a0b\u6211\u4f1a\u653e\u5728\u4e4b\u540e\u7684\u6587\u7ae0\u7edf\u4e00\u4ecb\u7ecd\u3002\u56de\u5230",(0,t.jsx)(n.em,{children:"OAuth2AuthorizedClientManager"}),"\u7c7b\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u540c\u65f6\u8fd8\u6307\u5b9a\u4e86",(0,t.jsx)(n.em,{children:"refreshToken()"}),",\u5b83\u5b9e\u73b0\u4e86\u5237\u65b0token\u903b\u8f91\uff0c\u5c06\u5728\u8bf7\u6c42\u8d44\u6e90\u670d\u52a1\u8fc7\u7a0b\u4e2daccess_token\u8fc7\u671f\u540e\u5c06\u5237\u65b0token\uff0c\u524d\u63d0\u662frefresh_token\u6ca1\u6709\u8fc7\u671f\uff0c\u5426\u5219\u4f60\u5c06\u91cd\u65b0\u6267\u884cOAuth2\u6388\u6743\u7801\u6d41\u7a0b\u3002"]}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2aController\u7c7b\uff0c\u4f7f\u7528WebClient\u8bf7\u6c42\u8d44\u6e90\u670d\u52a1\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@RestController\npublic class PkceClientController {\n\n    @Autowired\n    private WebClient webClient;\n\n    @GetMapping(value = "/client/test")\n    public List getArticles(@RegisteredOAuth2AuthorizedClient("messaging-client-pkce") OAuth2AuthorizedClient authorizedClient) {\n        return this.webClient\n                .get()\n                .uri("http://127.0.0.1:8090/resource/article")\n                .attributes(oauth2AuthorizedClient(authorizedClient))\n                .retrieve()\n                .bodyToMono(List.class)\n                .block();\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u8d44\u6e90\u670d\u52a1\u5668",children:"\u8d44\u6e90\u670d\u52a1\u5668"}),"\n",(0,t.jsx)(n.p,{children:"\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u4f7f\u7528Spring Security\u642d\u5efa\u4e00\u4e2a\u8d44\u6e90\u670d\u52a1\u5668\u3002"}),"\n",(0,t.jsx)(n.h4,{id:"maven-2",children:"maven"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-xml",children:"<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-web</artifactId>\n  <version>2.6.7</version>\n</dependency>\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-security</artifactId>\n  <version>2.6.7</version>\n</dependency>\n<dependency>\n  <groupId>org.springframework.boot</groupId>\n  <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>\n  <version>2.6.7</version>\n</dependency>\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u914d\u7f6e-2",children:"\u914d\u7f6e"}),"\n",(0,t.jsx)(n.p,{children:"\u901a\u8fc7application.yml\u914d\u7f6e\u8d44\u6e90\u670d\u52a1\u5668\u670d\u52a1\u7aef\u53e38070\uff0c\u5e76\u6307\u5b9a\u6388\u6743\u670d\u52a1\u5668jwk uri\uff0c\u7528\u4e8e\u83b7\u53d6\u516c\u94a5\u4fe1\u606f\u9a8c\u8bc1token\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"server:\n  port: 8090\n\nspring:\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          jwk-set-uri: http://127.0.0.1:8080/oauth2/jwks\n"})}),"\n",(0,t.jsx)(n.p,{children:"\u63a5\u4e0b\u6765\u914d\u7f6eSpring Security\u914d\u7f6e\u7c7b\uff0c\u6307\u5b9a\u53d7\u4fdd\u62a4\u7aef\u70b9\u8bbf\u95ee\u6743\u9650\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class SecurityConfig {\n\n    @Bean\n    public SecurityFilterChain defaultSecurityFilter(HttpSecurity http) throws Exception {\n        http.requestMatchers()\n                .antMatchers("/resource/article")\n                .and()\n                .authorizeHttpRequests((authorize) -> authorize\n                        .antMatchers("/resource/article")\n                        .hasAuthority("SCOPE_message.read")\n                        .mvcMatchers()\n                )\n                .oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt);\n        return http.build();\n    }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"\u4e0a\u8ff0\u914d\u7f6e\u7c7b\u4e2d\u6307\u5b9a/resource/article\u5fc5\u987b\u62e5\u6709message.read\u6743\u9650\u624d\u80fd\u8bbf\u95ee\uff0c\u5e76\u914d\u7f6e\u8d44\u6e90\u670d\u52a1\u4f7f\u7528JWT\u8eab\u4efd\u9a8c\u8bc1\u3002"}),"\n",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.p,{children:"\u4e4b\u540e\u6211\u4eec\u5c06\u521b\u5efaController\u7c7b\uff0c\u4f5c\u4e3a\u53d7\u4fdd\u62a4\u7aef\u70b9\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@RestController\npublic class ArticleRestController {\n\n    @GetMapping("/resource/article")\n    public List<String> article() {\n        return Arrays.asList("article1", "article2", "article3");\n    }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u8bbf\u95ee\u8d44\u6e90\u5217\u8868",children:"\u8bbf\u95ee\u8d44\u6e90\u5217\u8868"}),"\n",(0,t.jsxs)(n.p,{children:["\u542f\u52a8\u6240\u6709\u670d\u52a1\u540e\uff0c\u5728\u6d4f\u89c8\u5668\u4e2d\u8f93\u5165 ",(0,t.jsx)(n.a,{href:"http://127.0.0.1:8070/client/test",children:"http://127.0.0.1:8070/client/test"})," \uff0c\u901a\u8fc7\u6388\u6743\u670d\u52a1\u5668\u8ba4\u8bc1\u540e\uff0c\u60a8\u5c06\u5728\u9875\u9762\u4e2d\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\u4fe1\u606f\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'["article1","article2","article3"]\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u7ed3\u8bba",children:"\u7ed3\u8bba"}),"\n",(0,t.jsx)(n.p,{children:"\u5728Spring Security\u76ee\u524d\u7248\u672c\u4e2d\u4fdd\u5bc6\u5ba2\u6237\u7aef\u7684 PKCE \u5df2\u7ecf\u6210\u4e3a\u9ed8\u8ba4\u884c\u4e3a\u3002\u5728\u4fdd\u5bc6\u5ba2\u6237\u7aef\u6388\u6743\u7801\u6a21\u5f0f\u4e2d\u540c\u6837\u53ef\u4ee5\u4f7f\u7528PKCE\u3002"}),"\n",(0,t.jsxs)(n.p,{children:["\u4e0e\u5f80\u5e38\u4e00\u6837\uff0c\u672c\u6587\u4e2d\u4f7f\u7528\u7684\u6e90\u4ee3\u7801\u53ef",(0,t.jsx)(n.a,{href:"https://github.com/ReLive27/spring-security-oauth2-sample/tree/main/oauth2-pkce",children:"\u5728 GitHub \u4e0a"}),"\u83b7\u5f97\u3002"]})]})}function u(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},2868:(e,n,r)=>{r.d(n,{c:()=>t});const t=r.p+"assets/images/PKCE.drawio-d138d21a48d66bc9ea25c9c2bc909a32.png"},6672:(e,n,r)=>{r.d(n,{c:()=>t});const t=r.p+"assets/images/oauth2-1d655226e2321bf43f93d0cda5045d9f.png"},2172:(e,n,r)=>{r.d(n,{I:()=>o,M:()=>s});var t=r(1504);const i={},a=t.createContext(i);function s(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);